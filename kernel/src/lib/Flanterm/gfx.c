#include "flanterm.h"
#include "flanterm_backends/fb.h"
#include <limine.h>
#include "gfx.h"
#include <drivers/serial/printf.h>
#include <config.hpp>

__attribute__((section(".limine_requests")))
volatile struct limine_framebuffer_request fb_request = {
    .id = LIMINE_FRAMEBUFFER_REQUEST_ID,
    .revision = 0
};

struct limine_framebuffer* fb;
struct flanterm_context *ft_ctx;

uint64_t g_scr_height, g_scr_width;

void flanterm_initialise() {
    if (fb_request.response == (void*)0 || fb_request.response->framebuffer_count < 1) {
        asm volatile ("hlt;cli;");
    }

    fb = fb_request.response->framebuffers[0];

    ft_ctx = flanterm_fb_init(
        NULL,
        NULL,
        fb->address, fb->width, fb->height, fb->pitch,
        fb->red_mask_size, fb->red_mask_shift,
        fb->green_mask_size, fb->green_mask_shift,
        fb->blue_mask_size, fb->blue_mask_shift,
        NULL,
        NULL, NULL,
        NULL, NULL,
        NULL, NULL,
        NULL, 0, 0, 1,
        0, 0,
        5
    );

    g_scr_height = fb->height;
    g_scr_width = fb->width;
}

__attribute__((always_inline, hot))
uint32_t lerpRGB(uint32_t src, uint32_t dst, uint8_t intensity) {
    uint32_t sr = (src >> 16) & 0xFF;
    uint32_t sg = (src >>  8) & 0xFF;
    uint32_t sb =  src        & 0xFF;

    uint32_t dr = (dst >> 16) & 0xFF;
    uint32_t dg = (dst >>  8) & 0xFF;
    uint32_t db =  dst        & 0xFF;

    uint32_t r = sr + ((int32_t)(dr - sr) * intensity >> 8);
    uint32_t g = sg + ((int32_t)(dg - sg) * intensity >> 8);
    uint32_t b = sb + ((int32_t)(db - sb) * intensity >> 8);

    return (r << 16) | (g << 8) | b;
}

__attribute__((always_inline, hot))
void putpx(int x, int y, uint32_t colour) {
	if (x > g_scr_width-1 || y > g_scr_height-1 || x < 0 || y < 0) return;
	//uint32_t currcolour = ((volatile uint32_t *)fb->address)[y * (fb->pitch/4) + x];
	//uint32_t final = colour & 0xFFFFFF/*lerpRGB(currcolour, colour, (colour >> 24) & 0xFF)*/;
	((volatile uint32_t *)fb->address)[y * (fb->pitch/4) + x] = colour;
}

__attribute__((always_inline, hot))
uint32_t getpx(int x, int y) {
	if (x > g_scr_width-1 || y > g_scr_height-1 || x < 0 || y < 0) return (uint32_t)-1;
	return ((volatile uint32_t *)fb->address)[y * (fb->pitch/4) + x];
}

void* get_ftctx() {return (void*)ft_ctx;}

#define POINTER_SIZE_X 13
#define POINTER_SIZE_Y 18

/*uint32_t pointer_data[] = {
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x7FFFFFFF, 0x7FFFFFFF, 0x7FFFFFFF, 0x7FFFFFFF, 0x7FFFFFFF, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x7FFFFFFF, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0xFF000000, 0x7FFFFFFF, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
};*/

uint32_t pointer_data[] = {
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0x000000, 0xFFFFFF,
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000,
    0x000000, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x123212, 0x123212, 0x123212
};

static uint32_t old_pointer_data[POINTER_SIZE_X * POINTER_SIZE_Y];

__attribute__((hot, always_inline))
void draw_mouse_pointer(int old_x, int old_y, int x, int y, int button_state_lmb, int button_state_mmb, int button_state_rmb) {
#ifdef CONFIG_DEBUG_MOUSE
    printf("OLD_X:\t%d\n\rOLD_Y:\t%d\n\rX:   \t%d\n\rY:   \t%d\n\r", old_x, old_y, x, y);
    printf("LMB: %s / MMB: %s / RMB: %s\n\r", button_state_lmb ? "MAKE!" : "BREAK", button_state_mmb ? "MAKE!" : "BREAK", button_state_rmb ? "MAKE!" : "BREAK");
#endif
}

void fb_clrscr(int no_cur) {
    flanterm_write(ft_ctx, "\033[2J\033[H", 7);
    if (no_cur)
        flanterm_write(ft_ctx, "\033[?25l", 6);
    else
        flanterm_write(ft_ctx, "\033[?25h", 6);
    for (size_t i = 0; i < fb->height * fb->pitch; i++) {
        ((volatile uint32_t*)fb->address)[0] = 0;
    }
}
